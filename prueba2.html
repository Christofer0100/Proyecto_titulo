<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Solicitudes - AsignaciÃ³n de Conductor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================
       DiseÃ±o con variables
       ========================= */
    :root{
      color-scheme: light dark;
      --bg: #f7f8fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --border-strong:#d1d5db;
      --primary: #2563eb;
      --primary-600:#1d4ed8;
      --primary-50:#eef2ff;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --row: #ffffff;
      --row-alt: #f9fafb;
      --row-hover:#f3f4f6;
      --badge-bg:#f3f4f6;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0d10;
        --card:#12161c;
        --text:#e5e7eb;
        --muted:#9ca3af;
        --border:#1f2937;
        --border-strong:#374151;
        --primary:#60a5fa;
        --primary-600:#3b82f6;
        --primary-50:#0b1220;
        --row:#151a21;
        --row-alt:#11161d;
        --row-hover:#1a212a;
        --badge-bg:#17202a;
      }
    }

    html,body{height:100%}
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
    }

    h1{
      margin:0 0 16px;
      font-size: clamp(1.1rem, 1vw + 1rem, 1.6rem);
      letter-spacing:.2px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.06);
      overflow:hidden;
    }

    .toolbar{
      display:flex; align-items:center; gap:12px;
      padding: 16px; border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card), var(--border) 6%), var(--card));
    }
    .toolbar input{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border-strong);
      background: transparent; color:var(--text); outline: none; min-width:260px;
      transition: border-color .2s, box-shadow .2s;
    }
    .toolbar input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary), transparent 80%);
    }
    .muted{ color:var(--muted); font-size:.92rem; }

    /* ===== Tabla ===== */
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:900px; }
    thead th{
      position: sticky; top:0; z-index: 2;
      background: linear-gradient(180deg, color-mix(in srgb, var(--card), #fff 8%), var(--card));
      color: var(--muted);
      font-weight: 600;
      letter-spacing:.3px;
      border-bottom:1px solid var(--border-strong);
      padding:12px 14px;
      text-align:left;
      backdrop-filter:saturate(180%) blur(4px);
    }
    tbody td{
      padding:14px;
      border-bottom:1px solid var(--border);
      background:var(--row);
    }
    tbody tr:nth-child(even) td{ background:var(--row-alt); }
    tbody tr:hover td{ background:var(--row-hover); }

    /* Ancho mÃ­nimo para Ãºltima columna */
    th:last-child, td:last-child{ width: 120px; }

    .pill{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:4px 10px; border-radius:999px; font-size:.8rem;
      background:var(--primary-50); color:var(--primary-600);
      border:1px solid color-mix(in srgb, var(--primary-600), transparent 70%);
    }

    .badge{
      padding:4px 10px; border-radius:999px; font-size:.78rem;
      border:1px solid var(--border-strong); background:var(--badge-bg);
    }
    .badge.NUEVA{ background: color-mix(in srgb, var(--warning), transparent 82%); border-color: color-mix(in srgb, var(--warning), transparent 50%); color: color-mix(in srgb, var(--warning), #000 20%); }
    .badge.ASIGNADA{ background: color-mix(in srgb, var(--success), transparent 85%); border-color: color-mix(in srgb, var(--success), transparent 55%); color: color-mix(in srgb, var(--success), #000 10%); }

    .btn{
      --_bg: transparent;
      --_bc: var(--border-strong);
      --_fg: var(--text);
      padding:10px 12px; border-radius:10px; border:1px solid var(--_bc);
      background: var(--_bg); color: var(--_fg); cursor:pointer;
      transition: transform .04s, background-color .15s, border-color .15s, box-shadow .15s;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{ --_bg: var(--primary); --_bc: var(--primary); --_fg: #fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* ===== Modal nativo estilizado ===== */
    dialog::backdrop{ background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    dialog{ border:none; padding:0; border-radius:16px; width:560px; max-width:96vw; background:var(--card); color:var(--text); }
    .modal-header{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .modal-body{ padding:16px; display:grid; gap:12px; }
    .modal-footer{ padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }
    select, input[type="datetime-local"]{
      width:100%; padding:10px 12px; border:1px solid var(--border-strong); border-radius:10px; background:transparent; color:var(--text);
      outline:none; transition:border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="datetime-local"]:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary), transparent 80%);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Solicitudes</h1>

    <div class="card">
      <div class="toolbar">
        <input id="q" type="search" placeholder="Buscar por nombre, telÃ©fono, origen o destinoâ€¦" />
        <span id="status" class="muted">â€”</span>
      </div>

      <div class="table-wrap">
        <table aria-label="Tabla de solicitudes">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tenista</th>
              <th>TelÃ©fono</th>
              <th>Hora salida</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Estado</th>
              <th>Asignar</th>
            </tr>
          </thead>
          <tbody id="tbody-solicitudes">
            <!-- JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal asignaciÃ³n -->
  <dialog id="dlg-asignacion" aria-labelledby="dlg-title">
    <form method="dialog">
      <div class="modal-header">
        <strong id="dlg-title">Asignar conductor</strong>
        <button class="btn" value="cancel" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div><span class="muted">Solicitud:</span> <span id="dlg-sol-info" class="pill"></span></div>
        <label>
          <span class="muted">Conductor</span>
          <select id="sel-conductor"></select>
        </label>
        <label>
          <span class="muted">Fecha y hora agendada</span>
          <input id="dt-agenda" type="datetime-local" />
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn" value="cancel">Cancelar</button>
        <button id="btn-confirm" class="btn primary" value="confirm">Asignar</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ============== CONFIG ============== */
    const API_BASE = 'https://brought-favourite-met-development.trycloudflare.com/api';  // <- cambia esto si usas tÃºnel
    const TOKEN = '';                               // <- o toma de localStorage si corresponde

    /* ============== HELPERS ============== */
    const $tbody = document.getElementById('tbody-solicitudes');
    const $q = document.getElementById('q');
    const $status = document.getElementById('status');
    const $dlg = document.getElementById('dlg-asignacion');
    const $dlgSolInfo = document.getElementById('dlg-sol-info');
    const $selConductor = document.getElementById('sel-conductor');
    const $dtAgenda = document.getElementById('dt-agenda');

    let solicitudes = [];
    let conductores = [];
    let currentSolicitudId = null;

    function headersJSON(){
      const h = { 'Content-Type': 'application/json' };
      if (TOKEN) h['Authorization'] = `Token ${TOKEN}`;
      return h;
    }
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { ...opts, headers: { ...headersJSON(), ...(opts.headers||{}) }});
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }
    const fmtHora = t => t ? String(t).slice(0,5) : '-';

    /* ============== RENDER ============== */
        function renderTabla(items){
    $tbody.innerHTML = '';
    if(!items.length){
        $tbody.innerHTML = `<tr>
        <td colspan="8" class="muted" style="text-align:center;padding:36px;">
            Sin datos
        </td>
        </tr>`;
        return;
    }

    $tbody.innerHTML = items.map(s => {
        const tenista = `${s.form_nombres ?? ''} ${s.form_apellidos ?? ''}`.trim() || '(sin nombre)';
        const tel = s.form_telefono || s.tenista?.numero || 'â€”';

        // ðŸ‘‡ AquÃ­ estÃ¡ el fix importante
        const origen  = s?.origen?.salida ?? s?.origen ?? 'â€”';
        const destino = s?.destino?.lugar ?? s?.destino ?? 'â€”';

        const estado = s.estado || 'NUEVA';

        return `
        <tr>
            <td>${s.id}</td>
            <td>${tenista}</td>
            <td>${tel}</td>
            <td>${fmtHora(s.hora_salida)}</td>
            <td>${origen}</td>
            <td>${destino}</td>
            <td><span class="badge ${estado}">${estado}</span></td>
            <td><button class="btn" data-assign="${s.id}">Asignar</button></td>
        </tr>
        `;
    }).join('');
}

    function filtrar(){
      const term = $q.value.trim().toLowerCase();
      if(!term) return renderTabla(solicitudes);
      const out = solicitudes.filter(s => {
        const tenista = `${s.form_nombres ?? ''} ${s.form_apellidos ?? ''}`.toLowerCase();
        const tel = (s.form_telefono || s.tenista?.numero || '').toLowerCase();
        const origen = (s.origen?.salida || '').toLowerCase();
        const destino = (s.destino?.lugar || '').toLowerCase();
        return tenista.includes(term) || tel.includes(term) || origen.includes(term) || destino.includes(term);
      });
      renderTabla(out);
      $status.textContent = `${out.length} resultado(s)`;
    }

    /* ============== MODAL ============== */
    function abrirModalAsignacion(sol){
      currentSolicitudId = sol.id;
      $dlgSolInfo.textContent = `#${sol.id} Â· ${sol.form_nombres ?? ''} ${sol.form_apellidos ?? ''}`.trim();
      $selConductor.innerHTML = conductores.length
        ? conductores.map(c => `<option value="${c.id}">${c.nombre} ${c.apellido ?? ''} Â· ${c.patente ?? ''}</option>`).join('')
        : `<option value="">(sin conductores)</option>`;
      const now = new Date(Date.now()+30*60*1000);
      $dtAgenda.value = new Date(now - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      $dlg.showModal();
    }

    async function asignarConductor(){
  const conductor_id = Number($selConductor.value);
  const fechaISO = new Date($dtAgenda.value);
  if(!conductor_id || isNaN(+fechaISO)){ 
    alert('Selecciona conductor y fecha/hora vÃ¡lida.'); 
    return; 
  }
  try{
    const payload = { 
      conductor_id, 
      fecha_hora_agendada: fechaISO.toISOString() 
    };
    await fetchJSON(`${API_BASE}/solicitudes/${currentSolicitudId}/asignar/`, {
      method:'POST',
      body: JSON.stringify(payload)
    });
    const idx = solicitudes.findIndex(s => s.id === currentSolicitudId);
    if(idx>=0) solicitudes[idx].estado = 'ASIGNADA';
    filtrar();
  }catch(e){ 
    console.error(e); 
    alert('No se pudo asignar.'); 
  }
}

    /* ============== DATA ============== */
    async function cargarConductores(){
      try{
        const data = await fetchJSON(`${API_BASE}/conductores/`);
        conductores = Array.isArray(data?.results) ? data.results : data;
      }catch(e){ console.warn('Conductores:', e); conductores=[]; }
    }
    async function cargarSolicitudes(){
      $status.textContent = 'Cargandoâ€¦';
      try{
        const data = await fetchJSON(`${API_BASE}/solicitudes/`);
        solicitudes = Array.isArray(data?.results) ? data.results : data;
        renderTabla(solicitudes);
        $status.textContent = `${solicitudes.length} resultado(s)`;
      }catch(e){
        console.warn('Solicitudes:', e);
        solicitudes = []; renderTabla([]); $status.textContent = 'Sin datos (error de API)';
      }
    }

    /* ============== EVENTS ============== */
    $tbody.addEventListener('click', (ev)=>{
      const id = ev.target?.dataset?.assign;
      if(!id) return;
      const sol = solicitudes.find(x => String(x.id) === String(id));
      if(sol) abrirModalAsignacion(sol);
    });
    $dlg.addEventListener('close', ()=>{ if($dlg.returnValue==='confirm') asignarConductor(); });
    $q.addEventListener('input', filtrar);

    /* ============== INIT ============== */
    (async()=>{
      await cargarConductores();
      await cargarSolicitudes();
    })();
  </script>
</body>
</html>
