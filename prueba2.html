<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Solicitudes - AsignaciÃ³n de Conductor</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/cdr.css">
</head>


<body>

  <div class="container">

    <aside>
            <div class="toggle">
                <div class="logo">
                    <img src="imagenes/3.jpg">
                    <h2><span class="primary">ATP</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-icons-sharp">
                        close
                    </span>
                </div>
            </div>

            <div class="sidebar">
                <a href="#">
                    <span class="material-icons-sharp">
                        dashboard
                    </span>
                    <h3>Dashboard</h3>
                </a>
                <a href="#">
                    <span class="material-icons-sharp">
                        person_outline
                    </span>
                    <h3>Tenista</h3>
                </a>
                <a href="/conductor.html">
                    <span class="material-icons-sharp">
                        person_outline
                    </span>
                    <h3>Conductores</h3>
                </a>
                <a href="#" class="active">
                    <span class="material-icons-sharp">
                        insights
                    </span>
                    <h3>Solicitudes</h3>
                </a>
                <a href="#">
                    <span class="material-icons-sharp">
                        receipt_long
                    </span>
                    <h3>Historial</h3>
                </a>
                <a href="/inicio_sesion.html">
                    <span class="material-icons-sharp">
                        logout
                    </span>
                    <h3>Cerrar SesiÃ³n</h3>
                </a>
            </div>
    </aside>

      <main>
            <h1>Solicitudes</h1>

            <div class="analyse">
                <div class="sales">
                    <div class="status">
                        <div class="info">
                            <h3>Kilometros recorridos</h3>
                            <h1>625 KM</h1>
                        </div>
                        <div class="progresss">
                            <svg>
                                <circle cx="38" cy="38" r="36"></circle>
                            </svg>
                            <div class="percentage">
                                <p>+64%</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="visits">
                    <div class="status">
                        <div class="info">
                            <h3>Viajes Coordinados</h3>
                            <h1>14</h1>
                        </div>
                        <div class="progresss">
                            <svg>
                                <circle cx="38" cy="38" r="36"></circle>
                            </svg>
                            <div class="percentage">
                                <p>68%</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="searches">
                    <div class="status">
                        <div class="info">
                            <h3>Viajes Totales</h3>
                            <h1>320</h1>
                        </div>
                        <div class="progresss">
                            <svg>
                                <circle cx="38" cy="38" r="36"></circle>
                            </svg>
                            <div class="percentage">
                                <p>+21%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

            <div class="recent-orders">
                <div class="card">
                  <div class="toolbar">
                    <input id="q" type="search" placeholder="Buscar por nombre o telÃ©fono" />
                    <span id="status" class="buscar">â€”</span>
                  </div>

                    <div class="table-wrap">
                      <table aria-label="Tabla de solicitudes">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Tenista</th>
                            <th>TelÃ©fono</th>
                            <th>Hora salida</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Estado</th>
                          </tr>
                        </thead>
                        <tbody id="tbody-solicitudes">
                          <!-- JS -->
                        </tbody>
                      </table>
                    </div>
                </div>
            </div>
          

        </main>

        <div class="right-section">
            <div class="nav">
                <button id="menu-btn">
                    <span class="material-icons-sharp">
                        menu
                    </span>
                </button>
                <div class="dark-mode">
                    <span class="material-icons-sharp active">
                        light_mode
                    </span>
                    <span class="material-icons-sharp">
                        dark_mode
                    </span>
                </div>

                <div class="profile">
                    <div class="info">
                        <p class="h">Hola, <b>Helena</b></p>
                        <small class="text-muted">Coordinador</small>
                    </div>
                </div>
            </div>
        </div>
        


  </div>


 

  <!-- Modal asignaciÃ³n -->
  <dialog id="dlg-asignacion" aria-labelledby="dlg-title">
    <form method="dialog">
      <div class="modal-header">
        <strong id="dlg-title">Asignar conductor</strong>
        <button class="btn-bla" value="cancel" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div><span class="muted">Solicitud:</span> <span id="dlg-sol-info" class="pill"></span></div>
        <label>
          <span class="muted">Conductor</span>
          <select id="sel-conductor"></select>
        </label>
        <label>
          <span class="muted">Fecha y hora agendada</span>
          <input id="dt-agenda" type="datetime-local" />
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn-bla" value="cancel">Cancelar</button>
        <button id="btn-confirm" class="btn secondary" value="confirm">Asignar</button>
      </div>
    </form>
  </dialog>




  <script>
    /* ============== CONFIG ============== */
    const API_BASE = 'https://shown-nine-modify-puzzles.trycloudflare.com/api';  // <- cambia esto si usas tÃºnel
    const TOKEN = '';                               // <- o toma de localStorage si corresponde

    /* ============== HELPERS ============== */
    const $tbody = document.getElementById('tbody-solicitudes');
    const $q = document.getElementById('q');
    const $status = document.getElementById('status');
    const $dlg = document.getElementById('dlg-asignacion');
    const $dlgSolInfo = document.getElementById('dlg-sol-info');
    const $selConductor = document.getElementById('sel-conductor');
    const $dtAgenda = document.getElementById('dt-agenda');

    let solicitudes = [];
    let conductores = [];
    let currentSolicitudId = null;

    function headersJSON(){
      const h = { 'Content-Type': 'application/json' };
      if (TOKEN) h['Authorization'] = `Token ${TOKEN}`;
      return h;
    }
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { ...opts, headers: { ...headersJSON(), ...(opts.headers||{}) }});
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }
    const fmtHora = t => t ? String(t).slice(0,5) : '-';

    /* ============== RENDER ============== */
        function renderTabla(items){
    $tbody.innerHTML = '';
    if(!items.length){
        $tbody.innerHTML = `<tr>
        <td colspan="8" class="muted" style="text-align:center;padding:36px;">
            Sin datos
        </td>
        </tr>`;
        return;
    }

    $tbody.innerHTML = items.map(s => {
        const tenista = `${s.form_nombres ?? ''} ${s.form_apellidos ?? ''}`.trim() || '(sin nombre)';
        const tel = s.form_telefono || s.tenista?.numero || 'â€”';

        // ðŸ‘‡ AquÃ­ estÃ¡ el fix importante
        const origen  = s?.origen?.salida ?? s?.origen ?? 'â€”';
        const destino = s?.destino?.lugar ?? s?.destino ?? 'â€”';

        const estado = s.estado || 'NUEVA';

        return `
        <tr>
            <td>${s.id}</td>
            <td>${tenista}</td>
            <td>${tel}</td>
            <td>${fmtHora(s.hora_salida)}</td>
            <td>${origen}</td>
            <td>${destino}</td>
            <td><span class="badge ${estado}">${estado}</span></td>
            <td><button class="btn" data-assign="${s.id}">Asignar</button></td>
        </tr>
        `;
    }).join('');
    }

    function filtrar(){
      const term = $q.value.trim().toLowerCase();
      if(!term) return renderTabla(solicitudes);
      const out = solicitudes.filter(s => {
        const tenista = `${s.form_nombres ?? ''} ${s.form_apellidos ?? ''}`.toLowerCase();
        const tel = (s.form_telefono || s.tenista?.numero || '').toLowerCase();
        const origen = (s.origen?.salida || '').toLowerCase();
        const destino = (s.destino?.lugar || '').toLowerCase();
        return tenista.includes(term) || tel.includes(term) || origen.includes(term) || destino.includes(term);
      });
      renderTabla(out);
      $status.textContent = `${out.length} resultado(s)`;
    }

    /* ============== MODAL ============== */
    function abrirModalAsignacion(sol){
      currentSolicitudId = sol.id;
      $dlgSolInfo.textContent = `#${sol.id} Â· ${sol.form_nombres ?? ''} ${sol.form_apellidos ?? ''}`.trim();
      $selConductor.innerHTML = conductores.length
        ? conductores.map(c => `<option value="${c.id}">${c.nombre} ${c.apellido ?? ''} Â· ${c.patente ?? ''}</option>`).join('')
        : `<option value="">(sin conductores)</option>`;
      const now = new Date(Date.now()+30*60*1000);
      $dtAgenda.value = new Date(now - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      $dlg.showModal();
    }

    async function asignarConductor(){
  const conductor_id = Number($selConductor.value);
  const fechaISO = new Date($dtAgenda.value);
  if(!conductor_id || isNaN(+fechaISO)){ 
    alert('Selecciona conductor y fecha/hora vÃ¡lida.'); 
    return; 
  }
  try{
    const payload = { 
      conductor_id, 
      fecha_hora_agendada: fechaISO.toISOString() 
    };
    await fetchJSON(`${API_BASE}/solicitudes/${currentSolicitudId}/asignar/`, {
      method:'POST',
      body: JSON.stringify(payload)
    });
    const idx = solicitudes.findIndex(s => s.id === currentSolicitudId);
    if(idx>=0) solicitudes[idx].estado = 'ASIGNADA';
    filtrar();
  }catch(e){ 
    console.error(e); 
    alert('No se pudo asignar.'); 
  }
}

    /* ============== DATA ============== */
    async function cargarConductores(){
      try{
        const data = await fetchJSON(`${API_BASE}/conductores/`);
        conductores = Array.isArray(data?.results) ? data.results : data;
      }catch(e){ console.warn('Conductores:', e); conductores=[]; }
    }
    async function cargarSolicitudes(){
      $status.textContent = 'Cargandoâ€¦';
      try{
        const data = await fetchJSON(`${API_BASE}/solicitudes/`);
        solicitudes = Array.isArray(data?.results) ? data.results : data;
        renderTabla(solicitudes);
        $status.textContent = `${solicitudes.length} resultado(s)`;
      }catch(e){
        console.warn('Solicitudes:', e);
        solicitudes = []; renderTabla([]); $status.textContent = 'Sin datos (error de API)';
      }
    }

    /* ============== EVENTS ============== */
    $tbody.addEventListener('click', (ev)=>{
      const id = ev.target?.dataset?.assign;
      if(!id) return;
      const sol = solicitudes.find(x => String(x.id) === String(id));
      if(sol) abrirModalAsignacion(sol);
    });
    $dlg.addEventListener('close', ()=>{ if($dlg.returnValue==='confirm') asignarConductor(); });
    $q.addEventListener('input', filtrar);

    /* ============== INIT ============== */
    (async()=>{
      await cargarConductores();
      await cargarSolicitudes();
    })();
  </script>
  <script src="/js/coordinador.js"></script>
</body>
</html>
