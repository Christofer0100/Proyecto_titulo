<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ATP Chile Open – Predicciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Estilos propios -->
  <link rel="stylesheet" href="/css/prediccion.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
</head>
<body>

  <div class="container">

    <aside>
            <div class="toggle">
                <div class="logo">
                    <img src="/imagenes/3.jpg">
                    <h2><span class="primary">ATP</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-icons-sharp">
                        close
                    </span>
                </div>
            </div>

            <div class="sidebar">
                <a href="#" class="active">
                    <span class="material-icons-sharp">
                        dashboard
                    </span>
                    <h3>Dashboard</h3>
                </a>
                <a href="/tenistas.html">
                    <span class="material-icons-sharp">
                        person_outline
                    </span>
                    <h3>Tenista</h3>
                </a>
                <a href="/conductor.html" class="">
                    <span class="material-icons-sharp">
                        person_outline
                    </span>
                    <h3>Conductores</h3>
                </a>
                <a href="/prueba2.html" class="">
                    <span class="material-icons-sharp">
                        insights
                    </span>
                    <h3>Solicitudes</h3>
                </a>
                <a href="/reservas.html">
                    <span class="material-icons-sharp">
                        receipt_long
                    </span>
                    <h3>Reservas</h3>
                </a>
                <a href="/inicio_sesion.html">
                    <span class="material-icons-sharp">
                        logout
                    </span>
                    <h3>Cerrar Sesión</h3>
                </a>
            </div>
    </aside>

        <main>
            <h1>Predicciones</h1>

  <section class="pred pred-page"><!-- NAMESPACE LOCAL -->

    <!-- Info del modelo -->
    <div class="pred-stat-grid">
      <div class="pred-card pred-center">
        <div class="pred-muted">Clases: Origen / Destino</div>
        <div id="m_classes" class="pred-stat">—</div>
      </div>
      <div class="pred-card pred-center">
        <div class="pred-muted">Métricas (F1)</div>
        <div id="m_f1" class="pred-stat">—</div>
      </div>
    </div>

    <!-- Resumen top1 -->
    <div class="pred-result-grid">
      <div class="pred-card">
        <div class="pred-muted" style="margin-bottom:6px">Origen más probable</div>
        <div id="best_origen" class="pred-stat">—</div>
        <div id="best_origen_prob" class="pred-muted">—</div>
      </div>
      <div class="pred-card">
        <div class="pred-muted" style="margin-bottom:6px">Destino más probable</div>
        <div id="best_destino" class="pred-stat">—</div>
        <div id="best_destino_prob" class="pred-muted">—</div>
      </div>
    </div>

    <!-- Paneles -->
    <div class="pred-panels">

      <!-- Predicción ORIGEN -->
      <section class="pred-card pred-panel">
        <h4 class="pred-title primary">Predicción de Origen</h4>

        <div class="pred-form-grid">
          <div class="pred-group">
            <label>Día de la semana</label>
            <select id="dia" class="pred-select">
              <option value="0">Lunes</option>
              <option value="1">Martes</option>
              <option value="2">Miércoles</option>
              <option value="3">Jueves</option>
              <option value="4">Viernes</option>
              <option value="5">Sábado</option>
              <option value="6">Domingo</option>
            </select>
          </div>
          <div class="pred-group">
            <label>Hora</label>
            <input type="time" id="hora" class="pred-input" value="10:00">
          </div>
        </div>

        <button class="pred-btn primary" id="btnOrigen">Predecir Origen</button>

        <div class="pred-table-wrap">
          <table class="pred-table">
            <thead><tr><th>ORIGEN</th><th>Probabilidad</th></tr></thead>
            <tbody id="tablaOrigen"><tr><td colspan="2" class="pred-empty">Sin datos</td></tr></tbody>
          </table>
        </div>

        <canvas id="chartOrigen" height="140"></canvas>
      </section>

      <!-- Predicción DESTINO -->
      <section class="pred-card pred-panel">
        <h4 class="pred-title success">Predicción de Destino</h4>

        <div class="pred-form-grid">
          <div class="pred-group">
            <label>Día</label>
            <select id="dia_dest" class="pred-select">
              <option value="0">Lunes</option>
              <option value="1">Martes</option>
              <option value="2">Miércoles</option>
              <option value="3">Jueves</option>
              <option value="4">Viernes</option>
              <option value="5">Sábado</option>
              <option value="6">Domingo</option>
            </select>
          </div>
          <div class="pred-group">
            <label>Hora</label>
            <input type="time" id="hora_dest" class="pred-input" value="10:00">
          </div>
          <div class="pred-group">
            <label>Origen</label>
            <select id="origen" class="pred-select"></select>
          </div>
        </div>

        <button class="pred-btn success" id="btnDestino">Predecir Destino</button>

        <div class="pred-table-wrap">
          <table class="pred-table">
            <thead><tr><th>DESTINO</th><th>Probabilidad</th></tr></thead>
            <tbody id="tablaDestino"><tr><td colspan="2" class="pred-empty">Sin datos</td></tr></tbody>
          </table>
        </div>

        <canvas id="chartDestino" height="140"></canvas>
      </section>
    </div>

    <!-- Historial -->
    <section class="pred-card pred-history">
      <div class="pred-history-head">
        <h5 style="font-size:18px; margin:0">Historial de consultas</h5>
        <button id="clearHistory" class="pred-btn ghost">Limpiar historial</button>
      </div>
      <div class="pred-table-wrap">
        <table class="pred-table">
          <thead>
            <tr>
              <th>Fecha/Hora</th><th>Día</th><th>Hora</th><th>Origen Top1</th><th>Destino Top1</th>
            </tr>
          </thead>
          <tbody id="historialBody">
            <tr><td colspan="5" class="pred-empty">Sin consultas aún</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </section>

        </main>

        <div class="right-section">
            <div class="nav">
                <button id="menu-btn">
                    <span class="material-icons-sharp">
                        menu
                    </span>
                </button>
                <div class="dark-mode">
                    <span class="material-icons-sharp active">
                        light_mode
                    </span>
                    <span class="material-icons-sharp">
                        dark_mode
                    </span>
                </div>

                <div class="profile">
                    <div class="info">
                        <p>Hola, <b>Helena</b></p>
                        <small class="text-muted">Coordinador</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
  /* tu JS original tal cual (no requiere cambios) */
  const API = "http://127.0.0.1:8000";
  let chartOrigen, chartDestino;
  const dayNames = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];

  function hhToHour(intime) {
    if(!intime) return 0;
    const h = parseInt(String(intime).split(":")[0], 10);
    return isNaN(h) ? 0 : h;
  }
  function pct(x){ return (x*100).toFixed(2) + "%"; }
  function nowStr(){ return new Date().toLocaleString(); }

  async function loadMetaMetrics(){
    try{
      const meta = await (await fetch(`${API}/meta`)).json();
      const sel = document.getElementById("origen");
      sel.innerHTML = "";
      meta.origenes_validos_para_destino.forEach(o=>{
        const op = document.createElement("option");
        op.value=o; op.textContent=o; sel.appendChild(op);
      });

      const metrics = await (await fetch(`${API}/metrics`)).json();
      document.getElementById("m_classes").textContent = `${metrics.num_clases.origen} / ${metrics.num_clases.destino}`;
      const f1o = metrics?.origen?.f1_macro, f1d = metrics?.destino?.f1_macro;
      document.getElementById("m_f1").textContent = (f1o && f1d) ? `Origen ${(f1o*100).toFixed(1)}% · Destino ${(f1d*100).toFixed(1)}%` : "No disponible";
    } catch(e){
      document.getElementById("m_classes").textContent = "—";
      document.getElementById("m_f1").textContent = "—";
    }
  }

  function renderTable(rows, containerId, key){
    const tbody = document.getElementById(containerId);
    if(!rows || rows.length===0){
      tbody.innerHTML = `<tr><td colspan="2" class="empty">Sin datos</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r=>`<tr><td>${r[key]}</td><td>${pct(r.prob)}</td></tr>`).join("");
  }

  function renderBar(canvasId, labels, values, color){
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = { labels, datasets: [{ label: 'Probabilidad', data: values, borderWidth: 1, backgroundColor: color }] };
    const opt = { scales: { y: { beginAtZero: true, ticks: { callback: v => v*100 + '%' }, max: 1 } } };
    return new Chart(ctx, { type:'bar', data, options: opt });
  }

  function loadHistory(){
    const tbody = document.getElementById("historialBody");
    const hist = JSON.parse(localStorage.getItem("hist_atp") || "[]");
    if(hist.length===0){ tbody.innerHTML = `<tr><td colspan="5" class="empty">Sin consultas aún</td></tr>`; return; }
    tbody.innerHTML = hist.map(h=>`
      <tr>
        <td>${h.ts}</td><td>${h.dia}</td><td>${h.hora}</td>
        <td>${h.origenTop1 ?? '—'}</td><td>${h.destinoTop1 ?? '—'}</td>
      </tr>`).join("");
  }
  function pushHistory(entry){
    const hist = JSON.parse(localStorage.getItem("hist_atp") || "[]");
    hist.unshift(entry);
    localStorage.setItem("hist_atp", JSON.stringify(hist.slice(0,30)));
    loadHistory();
  }
  document.getElementById("clearHistory").addEventListener("click", ()=>{
    localStorage.removeItem("hist_atp"); loadHistory();
  });

  document.getElementById("btnOrigen").addEventListener("click", async ()=>{
    const dia = parseInt(document.getElementById("dia").value,10);
    const hora = hhToHour(document.getElementById("hora").value);

    const r = await fetch(`${API}/predict_origen`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ dia_semana: dia, hora_num: hora, top_n: 3 })
    });
    const data = await r.json();
    const rows = data.predicciones || [];

    renderTable(rows, "tablaOrigen", "origen");
    if(chartOrigen) chartOrigen.destroy();
    chartOrigen = renderBar("chartOrigen", rows.map(x=>x.origen), rows.map(x=>x.prob), "#0d6efd");

    if(rows[0]){
      document.getElementById("best_origen").textContent = rows[0].origen;
      document.getElementById("best_origen_prob").textContent = pct(rows[0].prob);
    }

    const sel = document.getElementById("origen");
    const top1 = rows[0]?.origen;
    if([...sel.options].some(o=>o.value===top1)) sel.value = top1;

    pushHistory({ ts: nowStr(), dia: dayNames[dia], hora: `${hora}:00`, origenTop1: rows[0]?.origen || "—", destinoTop1: "—" });
  });

  document.getElementById("btnDestino").addEventListener("click", async ()=>{
    const dia = parseInt(document.getElementById("dia_dest").value,10);
    const hora = hhToHour(document.getElementById("hora_dest").value);
    const origen = document.getElementById("origen").value;

    const r = await fetch(`${API}/predict_destino`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ dia_semana: dia, hora_num: hora, origen, top_n: 3 })
    });
    const data = await r.json();
    const rows = data.predicciones || [];

    renderTable(rows, "tablaDestino", "destino");
    if(chartDestino) chartDestino.destroy();
    chartDestino = renderBar("chartDestino", rows.map(x=>x.destino), rows.map(x=>x.prob), "#198754");

    if(rows[0]){
      document.getElementById("best_destino").textContent = rows[0].destino;
      document.getElementById("best_destino_prob").textContent = pct(rows[0].prob);
    }

    const hist = JSON.parse(localStorage.getItem("hist_atp") || "[]");
    if(hist[0]) { hist[0].destinoTop1 = rows[0]?.destino || "—"; localStorage.setItem("hist_atp", JSON.stringify(hist)); }
    loadHistory();
  });

  loadMetaMetrics();
  loadHistory();
</script>
<script src="/js/coordinador.js"></script>

</body>
</html>
